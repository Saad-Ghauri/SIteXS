{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual tour</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>


   

<link rel="stylesheet" href="{% static 'style.css' %}">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>

    <style>
        .active-hotspot {
    border: 2px solid #ff0000; /* Red border for active hotspot */
    background-color: #ffff00; /* Yellow background for better visibility */
    /* Add other styles as needed */
}


.pdf-container {
    position: relative;
    display: inline-block;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.pdf-canvas {
    width: 100%;
    height: 100%;
    display: block;
    border: none;
    
}

.hotspot {
    position: absolute;
    width: 20px;
    height: 20px;
    background-color: rgba(255, 0, 0, 0.5);
    border-radius: 50%;
    cursor: pointer;
}


        #context-menu {
            display: none;
            position: absolute;
            background-color: rgb(226, 196, 255);
            border: 1px solid black;
            
        }

        .content-container {
          position: relative;
          z-index: 1; /* Ensures content appears above A-Frame */
        }
        .z-container {
          position: relative;
          z-index: 1; /* Ensures content appears above A-Frame */
        }
        .zin {
            z-index: 1;
        }

      </style>
      

</head>
<body>
    
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Floorplans</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                {% for floorplan in floorplans %}
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="loadPdf('{{ floorplan.pdf.url }}', '{{ floorplan.id }}')">
                        {{ floorplan.name }}
                    </a>
                </li>
                {% endfor %}
               
            </ul>
        </div>
    </div>
    
   

    <!-- <div id="pdf-container" class="relative z-10">
        <canvas id="pdf-canvas" class="w-[300px] h-[200px]"></canvas>
        <div id="hotspot-layer" class="absolute top-0 w-52 h-52"></div>
    </div>
    <div id="context-menu" class="z-10">
        <button id="create-hotspot" class="z-10 w-full h-full">Create hotspot</button>
    </div> -->

    
     




    <div class="container  content-container z-container ">



        <div class="flex items-center justify-between p-3 bg-opacity-40 bg-indigo-700 text-white z-container">
            <a href="{% url 'create-tasks' %}"><button>Create a Task</button></a>

            <h1 class="text-2xl">{{ project.project_name }}</h1>
            
            <a href="{% url 'virtual' %}"><button class="mr-2 p-2 border rounded-md">Back to Dashboard</button></a>
             <button id="next-button" class="mr-2 p-2 text-sm  border rounded-md" onclick="changeImage(1)">Next</button>
        <button id="prev-button" class="mr-2 p-2 text-sm border rounded-md" onclick="changeImage(-1)">Previous</button>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="flex items-center">
                
                <input type="file" name="image" accept="image/*" class="mr-2 p-2 border rounded-md" />
                <input type="text" name="name" placeholder="Image Name" class="mr-2 p-2 border rounded-md text-black" />  <!-- Add input for image name -->
                <button type="submit" class="bg-indigo-700 text-white px-4 py-2 rounded-md hover:bg-indigo-800">Upload Image</button>
            </div>
        </form>
        
            <button id="toggleSidebar" class=" bg-white text-gray-800 p-2 rounded-lg shadow-md z-10">O</button>
            <div class="flex space-x-2 items-center"><img class="max-w-[30px]" src="{% static 'icons/user.png' %}" alt="" srcset=""><h1 class="font-semibold">{{ user.username }}</h1></div>
            
        </div>

        
        <button class="navbar-toggler p-3 z-container btn-outline-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>View Floorplans
          </button>
        <a href="{% url 'upload_floorplan' %}">upload_floorplan</a>
        
     
            
    </div>


   <div class="flex justify-between z-50">
     <div>
    <div class="relative inline-block text-left z-50">
        <button id="dropdown-toggle" type="button" class="inline-flex justify-between w-[200px] rounded-tl-lg rounded-tr-lg tracking-widest  shadow-sm p-1 bg-indigo-700 text-xs text-[10px] text-white  focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500">
          Floorplans
          <!-- Chevron Down Icon -->
          <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M10 14l6-6v-2l-6 6-6-6v2l6 6z"/>
          </svg>
        </button>
      
        <!-- Dropdown Content -->
       
          <div class="dropdown-content origin-top-right absolute right-0  w-[200px] rounded-b-lg  shadow-md bg-stone-300 ring-1 ring-black ring-opacity-5" style="display: none;">
            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
              <!-- Dropdown Items -->
              {% for floorplan in floorplans %}
              <ul class="">
                <li class="rounded-2xl shadow-md text-white w-3/4">
                  <a href="#"  onclick="loadPdf('{{ floorplan.pdf.url }}', '{{ floorplan.id }}')" class="block px-2  tracking-widest py-1  text-sm hover:text-indigo-700 " role="menuitem">{{ floorplan.name }} </a>
                </li>
              </ul>
              {% endfor %} 
            </div>
          </div>
       
      </div>
   
<div class="w-[300px]  flex z-container">
    <!-- UI Box -->
    <div class="bg-white w-[300px] h-[210px]  rounded-l-lg shadow-md">
        

        <!-- PDF Container Loop -->
        {% for floorplan in floorplans %}
        <div id="pdf-container-{{ floorplan.id }}" class="relative w-[300px]  rounded-md">
            <canvas  id="pdf-canvas-{{ floorplan.id }}" class="w-[300px] h-[210px] opacity-70 pdf-canvas " data-floorplan-id="{{ floorplan.id }}"></canvas>
            <div id="hotspot-layer-{{ floorplan.id }}" class="absolute top-0 w-fit" >
                
            </div>
            
        </div>
        {% endfor %}
        
    </div>
    

 
      
      <script>
        document.getElementById('dropdown-toggle').addEventListener('click', function() {
          var dropdownContent = document.querySelector('.dropdown-content');
          dropdownContent.style.display = dropdownContent.style.display === 'none' ? 'block' : 'none';
        });
      </script>
        <div class="w-20 h-hit bg-white p-2 rounded-r-lg flex flex-col justify-around items-center">
            <div>
                <button>
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 4L7 4" stroke="#5030E5" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M4 7L4 1" stroke="#5030E5" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        
                </button>
            </div>
            <div>
                <button>
                <svg width="8" height="2" viewBox="0 0 8 2" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 1L7 0.999999" stroke="#5030E5" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    
            </button>
        </div>
            <div>
                <button>
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 0.6V3.144C8 3.30313 7.93679 3.45574 7.82426 3.56826C7.71174 3.68079 7.55913 3.744 7.4 3.744C7.24087 3.744 7.08826 3.68079 6.97574 3.56826C6.86321 3.45574 6.8 3.30313 6.8 3.144V2.048L2.048 6.8H3.144C3.30313 6.8 3.45574 6.86321 3.56826 6.97574C3.68079 7.08826 3.744 7.24087 3.744 7.4C3.744 7.55913 3.68079 7.71174 3.56826 7.82426C3.45574 7.93679 3.30313 8 3.144 8H0.6C0.441514 7.99793 0.290103 7.93405 0.178027 7.82197C0.0659511 7.7099 0.00207197 7.55849 0 7.4V4.856C0 4.69687 0.063214 4.54426 0.175736 4.43174C0.288258 4.31921 0.44087 4.256 0.6 4.256C0.75913 4.256 0.911742 4.31921 1.02426 4.43174C1.13679 4.54426 1.2 4.69687 1.2 4.856V5.952L5.952 1.2H4.856C4.69687 1.2 4.54426 1.13679 4.43174 1.02426C4.31921 0.911742 4.256 0.75913 4.256 0.6C4.256 0.44087 4.31921 0.288258 4.43174 0.175736C4.54426 0.063214 4.69687 0 4.856 0H7.4C7.55849 0.00207197 7.7099 0.0659511 7.82197 0.178027C7.93405 0.290103 7.99793 0.441514 8 0.6Z" fill="#5030E5"/>
                        </svg>
                        
                    
            </button>
        </div>
            <div>
                <button>
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="4" cy="4" r="3.25" transform="rotate(90 4 4)" fill="white" stroke="#5030E5" stroke-width="1.5"/>
                        </svg>
                        
                        
                    
            </button>
        </div>
            <div>
                <button>
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 7.375V4.75V1" stroke="#5030E5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M1 1H7L5.125 2.875L7 4.75H1" stroke="#5030E5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        
                        
                    
            </button>
        </div>
            <div>
                <button>
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 7.22191V7.21875" stroke="#5030E5" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5 7.22191V7.21875" stroke="#5030E5" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4.99984 6.26939C4.99984 4.84085 6.33317 5.15828 6.33317 4.04718C6.33317 3.34587 5.73619 2.77734 4.99984 2.77734C4.40281 2.77734 3.89744 3.15105 3.72754 3.66623" stroke="#5030E5" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4.99984 6.26939C4.99984 4.84085 6.33317 5.15828 6.33317 4.04718C6.33317 3.34587 5.73619 2.77734 4.99984 2.77734C4.40281 2.77734 3.89744 3.15105 3.72754 3.66623" stroke="#5030E5" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5 9C7.20916 9 9 7.20916 9 5C9 2.79086 7.20916 1 5 1C2.79086 1 1 2.79086 1 5C1 7.20916 2.79086 9 5 9Z" stroke="#5030E5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5 9C7.20916 9 9 7.20916 9 5C9 2.79086 7.20916 1 5 1C2.79086 1 1 2.79086 1 5C1 7.20916 2.79086 9 5 9Z" stroke="#5030E5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        
                        
                    
            </button>
        </div>
            
        </div>
</div>
   </div>
   <div class=" w-min h-fit flex flex-col  bg-indigo-500  bg-opacity-40 rounded-lg z-50">
    <!-- <ul class=" ">
        {% for image in images %}
        <li class="text-xs text-white p-2 {% if images %}{{ images.0.image.name }} text-gray-600 {% endif %}">{{ image.name }}</li>
        {% endfor %}
        {% for marker in markers %}
        <li class="text-xs text-white p-2 {% if images %}{{ images.0.image.name }} text-gray-600 {% endif %}">{{ marker.title }}</li>
        {% endfor %}
    </ul> -->
    <button id="add-marker-button" class=" p-1 text-xs  border rounded-md">Add Marker</button>
    <button id="add-arrow-button" class=" p-1 text-xs  border rounded-md">Add Arrow</button>
    <button id="add-outline-sphere-button" class=" p-1 text-xs  border rounded-md">Add Outline Sphere</button>
    <button id="add-cube-button" class=" p-1 text-xs border rounded-md">Add Cube</button>
    <button></button>

    <!-- <div id="marker-modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 30%;">
            <form method="post">
                {% csrf_token %}
                {{ marker_form.as_p }}
                <button type="submit">Save Marker</button>
            </form>
            <button id="save-marker-button">Save Marker</button>
        </div>
    </div> -->
    
</div>



</div>
  

<div class="flex z-container w-min">

        <div class="bg-white" draggable="true">
            hello
        </div>

        <div class="bg-white">
            hello
        </div>
</div>
  

    <a-scene id="scene" class="z-0">
        <a-sky id="panorama-image" src="{% if images %}{{ images.0.image.url }}{% endif %}"></a-sky>

        <a-camera id="camera" camera="fov: 80; zoom: 1">
          <a-cursor ></a-cursor>
        </a-camera>
        
    </a-scene>
    <script>
        var pageNumPending = null;
        var pdfDocs = {};
        var activeFloorplan = null;
    
        function renderPage(num, canvas, ctx) {
            pdfDocs[activeFloorplan].getPage(num).then(function(page) {
                var viewport = page.getViewport({ scale: 2 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                var renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                };
                var renderTask = page.render(renderContext);
                renderTask.promise.then(function() {
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        }
    // Zoom In


        function loadPdf(url, id) {
            // Hide all PDF containers and context menus
            for (var floorplanId in pdfDocs) {
                document.getElementById('pdf-container-' + floorplanId).style.display = 'none';
                document.getElementById('hotspot-layer-' + floorplanId).innerHTML = ''; // Clear hotspots
                
            }
            var xhr = new XMLHttpRequest();
    xhr.open('GET', '/load_hotspots/' + id, true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            var hotspots = JSON.parse(xhr.responseText);
            hotspots.forEach(function(hotspot) {
                var hotspotDiv = document.createElement('div');
                hotspotDiv.className = 'hotspot';
                hotspotDiv.style.left = hotspot.x + 'px';
                hotspotDiv.style.top = hotspot.y + 'px';
                hotspotDiv.textContent = hotspot.name; // Display the name on the hotspot
                document.getElementById('hotspot-layer-' + id).appendChild(hotspotDiv);
                

            });
        }
    };
    xhr.send();
    
            // Show the selected PDF container
            document.getElementById('pdf-container-' + id).style.display = 'block';
    
            // Set the active floorplan
            activeFloorplan = id;
    
            // Set the canvas and context for the selected PDF
            var canvas = document.getElementById('pdf-canvas-' + id);
            var ctx = canvas.getContext('2d');
    
            // Load and render the selected PDF
            pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
                pdfDocs[id] = pdfDoc_;
                renderPage(1, canvas, ctx);
            });
        }
    
        document.addEventListener('contextmenu', function(event) {
            if (event.target.classList.contains('pdf-canvas')) {
                event.preventDefault();
                handleCanvasRightClick(event);
            }
        });
    
        function handleCanvasRightClick(event) {
            var id = event.target.getAttribute('data-floorplan-id');
            createHotspot(event, id);
        }

        function createHotspot(event, id) {
    var canvas = document.getElementById('pdf-canvas-' + id);
    var rect = canvas.getBoundingClientRect();
    var x = event.clientX - rect.left;
    var y = event.clientY - rect.top;


    // Prompt the user for the hotspot name
    var hotspotName = prompt("Please enter the name for the hotspot:");

    if (hotspotName) {
        var hotspot = document.createElement('div');
        hotspot.className = 'hotspot';
        hotspot.style.left = x + 'px';
        hotspot.style.top = y + 'px';
       
        hotspot.textContent = hotspotName; // Display the name on the hotspot

        document.getElementById('hotspot-layer-' + id).appendChild(hotspot);
         document.getElementById('hotspot-layer-' + id).appendChild(hotspot);
        hotspot.addEventListener('click', function() {
            handleHotspotClick(hotspot, id);
        });

        // Send the hotspot data to the server
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/save_hotspot/', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send('name=' + encodeURIComponent(hotspotName) + '&x=' + x + '&y=' + y + '&floorplan_id=' + id);
    } hotspot.draggable= 'true'
}

    
       
   </script>




    
   
<script>
    document.getElementById("add-arrow-button").addEventListener("click", function () {
      // Get the camera element
      var cameraEl = document.querySelector('#camera');
  
      // Create a new entity for the arrow
      var arrow = document.createElement('a-entity');
  
      // Get the world direction that the camera is looking
      var worldDir = new THREE.Vector3();
      cameraEl.object3D.getWorldDirection(worldDir);
  
      // Scale the world direction vector and add it to the camera's position
      var arrowPos = cameraEl.object3D.position.clone().add(worldDir.multiplyScalar(-5));
  
      // Set the position of the arrow to the position of the click event
      arrow.setAttribute('position', arrowPos);
  
      // Create an arrow using the line component
      var lines = [
          {start: '0 0 0', end: '0 1 0', color: 'yellow'},
          {start: '0 1 0', end: '-0.2 0.8 0', color: 'yellow'},
          {start: '0 1 0', end: '0.2 0.8 0', color: 'yellow'}
      ];
      
      for (var i = 1; i <= lines.length; i++) {
          var line = document.createElement('a-entity');
          line.setAttribute('line', {start: lines[i-1].start, end: lines[i-1].end, color: 'yellow'});
          arrow.appendChild(line);
      }
  
      // Add the arrow to the scene
      document.querySelector('#scene').appendChild(arrow);
  });
  </script>
<script>
    document.getElementById("add-cube-button").addEventListener("click", function () {
      // Get the camera element
      var cameraEl = document.querySelector('#camera');
  
      // Create a new entity for the cube
      var cube = document.createElement('a-entity');
  
      // Get the world direction that the camera is looking
      var worldDir = new THREE.Vector3();
      cameraEl.object3D.getWorldDirection(worldDir);
  
      // Scale the world direction vector and add it to the camera's position
      var cubePos = cameraEl.object3D.position.clone().add(worldDir.multiplyScalar(-5));
  
      // Set the position of the cube to the position of the click event
      cube.setAttribute('position', cubePos);
  
      // Create a cube using the box component
      cube.setAttribute('geometry', {primitive: 'box', width: 1, height: 1, depth: 1});
      cube.setAttribute('material', {color: 'red', opacity: 0.2, wireframe: true});
  
      // Add the cube to the scene
      document.querySelector('#scene').appendChild(cube);
  });
  </script>
<script>
    document.getElementById("add-outline-sphere-button").addEventListener("click", function () {
      // Get the camera element
      var cameraEl = document.querySelector('#camera');
  
      // Create a new entity for the sphere
      var sphere = document.createElement('a-entity');
  
      // Get the world direction that the camera is looking
      var worldDir = new THREE.Vector3();
      cameraEl.object3D.getWorldDirection(worldDir);
  
      // Scale the world direction vector and add it to the camera's position
      var spherePos = cameraEl.object3D.position.clone().add(worldDir.multiplyScalar(-5));
  
      // Set the position of the sphere to the position of the click event
      sphere.setAttribute('position', spherePos);
  
      // Create a sphere using the geometry component
      sphere.setAttribute('geometry', {primitive: 'sphere', radius: 1});
      sphere.setAttribute('material', {color: 'red', opacity: 0.1, wireframe: true});
  
      // Add the sphere to the scene
      document.querySelector('#scene').appendChild(sphere);
  });
  </script>


    
      
    <script>
        var images = [
            {% for image in images %}
                "{{ image.image.url }}",
            {% endfor %}
        ];
    
        var currentIndex = 0;
        var panoramaImage = document.getElementById("panorama-image");
        
        document.getElementById("next-button").addEventListener("click", function () {
            currentIndex = (currentIndex + 1) % images.length;
            panoramaImage.setAttribute("src", images[currentIndex]);
        });
    
        document.getElementById("prev-button").addEventListener("click", function () {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            panoramaImage.setAttribute("src", images[currentIndex]);
        });
    </script>


<script src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</body>
</html>






